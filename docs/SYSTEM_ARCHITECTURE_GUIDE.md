# 화장품 추천 시스템 아키텍처 가이드

## 시스템 개요

화장품 추천 시스템은 의약품-성분 상호작용을 고려한 안전한 개인화 추천을 제공하는 시스템입니다. 4단계 파이프라인(배제 → 감점 → 정렬 → 포맷팅)을 통해 사용자에게 최적의 화장품을 추천합니다.

## 전체 아키텍처

```
┌─────────────────────────────────────────────────────────────────┐
│                        API Layer                                │
├─────────────────────────────────────────────────────────────────┤
│  RecommendationController  │  AdminController  │  HealthController │
└─────────────────────────────────────────────────────────────────┘
                                    │
┌─────────────────────────────────────────────────────────────────┐
│                     Service Layer                               │
├─────────────────────────────────────────────────────────────────┤
│                RecommendationEngine                             │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ │
│  │ Eligibility │ │  Scoring    │ │  Ranking    │ │ Response    │ │
│  │   Engine    │ │   Engine    │ │  Service    │ │ Formatter   │ │
│  │   (배제)     │ │   (감점)     │ │   (정렬)     │ │  (포맷팅)    │ │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                    │
┌─────────────────────────────────────────────────────────────────┐
│                   Supporting Services                           │
├─────────────────────────────────────────────────────────────────┤
│ RuleService │ IngredientService │ ProductService │ HealthService │
└─────────────────────────────────────────────────────────────────┘
                                    │
┌─────────────────────────────────────────────────────────────────┐
│                     Data Layer                                  │
├─────────────────────────────────────────────────────────────────┤
│     PostgreSQL        │         SQLite         │    JSON Files   │
│   (Rules, Metadata)   │    (Products, Cache)   │  (Configuration) │
└─────────────────────────────────────────────────────────────────┘
```

## 핵심 컴포넌트

### 1. 배제 엔진 (Eligibility Engine)
**역할**: 안전하지 않은 제품 즉시 배제
- 의약품-성분 상호작용 검사
- 사용 맥락 기반 배제 (임신/수유, 사용 부위 등)
- 실시간 안전성 평가

**주요 특징**:
- 안전 우선 정책 (오류 시 배제)
- 5분 룰 캐시
- 배치 처리 최적화

### 2. 감점 엔진 (Scoring Engine)
**역할**: 위험도에 따른 차등 감점
- 동계열 중복 감점 상한 정책 (기본 50점)
- 심각도 배수 적용 (고위험 2.0x, 중위험 1.5x)
- 공정한 점수 산출

**주요 특징**:
- 룰 그룹별 상한 적용
- 심각도 기반 배수 조정
- 성능 최적화된 평가

### 3. 정렬 서비스 (Ranking Service)
**역할**: 6단계 tie-break 알고리즘 정렬
1. 최종 점수 (높을수록 좋음)
2. 의도 일치도 (높을수록 좋음)
3. 감점 룰 수 (적을수록 좋음)
4. 브랜드 선호도 (높을수록 좋음)
5. 카테고리 일치도 (높을수록 좋음)
6. 제품 ID (최신순)

**주요 특징**:
- 종합 추천 사유 생성
- 브랜드/카테고리 선호도 반영
- 안정적 정렬 보장

### 4. 결과 포매터 (Response Formatter)
**역할**: API 응답 표준화
- 실행 요약 및 통계 제공
- 클라이언트 친화적 형태 변환
- 에러 처리 및 민감 정보 필터링

**주요 특징**:
- 구조화된 응답 형태
- 성능 메트릭 포함
- 안전한 에러 노출

## 데이터 플로우

### 1. 추천 요청 처리 플로우
```
사용자 요청 (RecommendationRequest)
        ↓
[입력 검증 및 전처리]
        ↓
[제품 후보 조회] → ProductService
        ↓
[배제 엔진] → EligibilityEngine
        ↓ (안전한 제품만)
[감점 엔진] → ScoringEngine
        ↓ (점수 조정된 제품)
[정렬 서비스] → RankingService
        ↓ (순위 매겨진 제품)
[결과 포매터] → ResponseFormatter
        ↓
최종 응답 (RecommendationResponse)
```

### 2. 룰 적용 플로우
```
사용자 의약품 코드
        ↓
[의약품 코드 해석] → RuleService
        ↓
제품 성분 태그
        ↓
[성분 태그 매칭] → IngredientService
        ↓
[룰 조건 평가] → RuleService
        ↓
[배제/감점 결정]
```

## 성능 최적화 전략

### 1. 캐싱 전략
- **룰 캐시**: 5분 TTL, 메모리 캐시
- **성분 태그 캐시**: 제품별 배치 로딩
- **의약품 코드 캐시**: 해석 결과 캐시

### 2. 배치 처리
- 제품별 성분 태그 배치 조회
- 의약품 코드 배치 해석
- 룰 조건 배치 평가

### 3. 조기 종료
- 배제 조건 만족 시 즉시 중단
- 오류 발생 시 안전 모드 전환
- 타임아웃 기반 처리 중단

## 안전성 보장 메커니즘

### 1. 다층 안전망
```
1차: 입력 검증 (API Layer)
2차: 배제 엔진 (Safety First)
3차: 감점 엔진 (Risk Assessment)
4차: 결과 검증 (Response Validation)
```

### 2. 오류 처리 정책
- **배제 엔진**: 오류 시 모든 제품 배제
- **감점 엔진**: 오류 시 기본 점수 유지
- **정렬 서비스**: 오류 시 기본 정렬 적용
- **포매터**: 오류 시 구조화된 에러 응답

### 3. 룰 검증
- 룰 구조 유효성 검사
- 조건 평가 안전성 보장
- 버전 관리 및 롤백 지원

## 확장성 설계

### 1. 수평 확장
- 상태 비저장 서비스 설계
- 데이터베이스 읽기 복제본 지원
- 로드 밸런싱 친화적 구조

### 2. 수직 확장
- 메모리 효율적 알고리즘
- CPU 집약적 작업 최적화
- I/O 병목 최소화

### 3. 기능 확장
- 플러그인 아키텍처 지원
- 새로운 엔진 추가 용이성
- 룰 시스템 확장성

## 모니터링 및 관찰성

### 1. 성능 메트릭
```python
# 각 엔진별 성능 메트릭
- 처리 시간 (평균, 최대, 백분위수)
- 처리량 (TPS, 동시 요청 수)
- 에러율 (성공/실패 비율)
- 캐시 히트율
```

### 2. 비즈니스 메트릭
```python
# 추천 품질 메트릭
- 배제율 (안전성 지표)
- 감점율 (위험도 분포)
- 추천 다양성 (브랜드/카테고리)
- 사용자 만족도 (피드백 기반)
```

### 3. 시스템 헬스
```python
# 시스템 상태 모니터링
- 데이터베이스 연결 상태
- 룰셋 버전 및 활성 룰 수
- 메모리 사용량
- 응답 시간 분포
```

## 배포 및 운영

### 1. 환경 구성
```
Development → Staging → Production
     ↓           ↓          ↓
  SQLite    PostgreSQL  PostgreSQL
  (로컬)      (테스트)     (운영)
```

### 2. 설정 관리
- 환경별 설정 파일 분리
- 민감 정보 환경 변수 관리
- 룰셋 버전 관리

### 3. 배포 전략
- 블루-그린 배포
- 카나리 배포
- 롤백 계획

## 보안 고려사항

### 1. 데이터 보안
- 개인 의료 정보 암호화
- 데이터베이스 접근 제어
- 로그 민감 정보 마스킹

### 2. API 보안
- 인증/인가 체계
- 요청 속도 제한
- 입력 검증 및 새니타이징

### 3. 시스템 보안
- 의존성 취약점 관리
- 보안 헤더 설정
- 감사 로그 관리

## 문제 해결 가이드

### 1. 성능 문제
- **증상**: 응답 시간 증가
- **원인**: 캐시 미스, 복잡한 룰, 대용량 데이터
- **해결**: 캐시 최적화, 룰 단순화, 인덱스 추가

### 2. 정확성 문제
- **증상**: 부적절한 추천 결과
- **원인**: 룰 로직 오류, 데이터 품질 문제
- **해결**: 룰 검증, 데이터 정제, A/B 테스트

### 3. 가용성 문제
- **증상**: 서비스 중단, 에러 증가
- **원인**: 데이터베이스 장애, 메모리 부족
- **해결**: 헬스체크 강화, 자동 복구, 알림 설정

## 개발 가이드라인

### 1. 코드 품질
- 타입 힌트 필수 사용
- 단위 테스트 커버리지 80% 이상
- 코드 리뷰 필수

### 2. 성능 가이드라인
- 데이터베이스 쿼리 최적화
- 메모리 사용량 모니터링
- 비동기 처리 활용

### 3. 안전성 가이드라인
- 입력 검증 철저히
- 에러 처리 명시적으로
- 로깅 상세히

## 관련 문서
- [배제 엔진 가이드](ELIGIBILITY_ENGINE_GUIDE.md)
- [감점 엔진 가이드](SCORING_ENGINE_GUIDE.md)
- [정렬 서비스 가이드](RANKING_SERVICE_GUIDE.md)
- [결과 포매터 가이드](RESPONSE_FORMATTER_GUIDE.md)
- [API 가이드](FRONTEND_API_GUIDE.md)
- [개발자 통합 가이드](DEVELOPER_INTEGRATION_GUIDE.md)